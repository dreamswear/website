<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Créateurs - Dreamswear</title>
    <link rel="stylesheet" href="dashboard-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Styles spécifiques pour la gestion */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--gray-light);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .table-container {
            background: var(--dark-light);
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: var(--dark);
            padding: 15px;
            text-align: left;
            color: var(--primary);
            font-weight: 600;
            border-bottom: 1px solid var(--border);
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            color: #cccccc;
        }
        
        tr:hover {
            background: rgba(212, 175, 55, 0.05);
        }
        
        .actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-view {
            background: var(--info);
            color: white;
        }
        
        .btn-delete {
            background: var(--danger);
            color: white;
        }
        
        .btn-edit {
            background: var(--warning);
            color: var(--dark);
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-active {
            background: rgba(40, 167, 69, 0.2);
            color: var(--success);
        }
        
        .status-inactive {
            background: rgba(108, 117, 125, 0.2);
            color: var(--gray);
        }
        
        .form-modal {
            background: var(--dark-light);
            border-radius: var(--radius);
            padding: 30px;
            margin-top: 20px;
            border: 1px solid var(--border);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container" style="max-width: 1400px; margin: 40px auto; padding: 20px;">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px;">
            <h1><i class="fas fa-user-cog"></i> Gestion Administrateur</h1>
            <div style="display: flex; gap: 10px;">
                <a href="dashboard-management.html" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Retour au Dashboard
                </a>
            </div>
        </header>

        <!-- Onglets -->
        <div class="tabs">
            <button class="tab active" data-tab="creators">Gestion Créateurs</button>
            <button class="tab" data-tab="events">Gestion Événements</button>
        </div>

        <!-- Onglet Créateurs -->
        <div id="creatorsTab" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card large">
                    <i class="fas fa-users"></i>
                    <div class="stat-content">
                        <span class="stat-number" id="totalCreators">0</span>
                        <span class="stat-label">Créateurs</span>
                    </div>
                </div>
                <div class="stat-card large">
                    <i class="fas fa-user-check"></i>
                    <div class="stat-content">
                        <span class="stat-number" id="activeCreators">0</span>
                        <span class="stat-label">Actifs (30j)</span>
                    </div>
                </div>
                <div class="stat-card large">
                    <i class="fas fa-portrait"></i>
                    <div class="stat-content">
                        <span class="stat-number" id="completePortfolios">0</span>
                        <span class="stat-label">Portfolios complets</span>
                    </div>
                </div>
            </div>

            <section style="margin-top: 40px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2><i class="fas fa-user-tie"></i> Liste des Créateurs</h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <input type="text" id="searchCreator" placeholder="Rechercher un créateur..." 
                               class="form-control">
                        <select id="filterDomain" class="form-control">
                            <option value="">Tous les domaines</option>
                            <option value="haute-couture">Haute Couture</option>
                            <option value="streetwear">Streetwear</option>
                            <option value="designer">Designer</option>
                            <option value="bijoux">Bijoux</option>
                            <option value="tricot">Tricot</option>
                        </select>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nom / Marque</th>
                                <th>Email</th>
                                <th>Domaine</th>
                                <th>Portfolio</th>
                                <th>Date inscription</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="creatorsTable">
                            <!-- Chargé dynamiquement -->
                        </tbody>
                    </table>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                    <div id="paginationInfo" style="color: var(--gray-light);"></div>
                    <div>
                        <button id="prevPage" class="btn btn-outline" style="margin-right: 10px;">Précédent</button>
                        <button id="nextPage" class="btn btn-outline">Suivant</button>
                    </div>
                </div>
            </section>
        </div>

        <!-- Onglet Événements -->
        <div id="eventsTab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2><i class="fas fa-calendar-plus"></i> Gérer les Événements</h2>
                <button id="addEventBtn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Ajouter un événement
                </button>
            </div>

            <!-- Formulaire d'ajout d'événement (masqué par défaut) -->
            <div id="eventFormContainer" class="form-modal" style="display: none;">
                <h3><i class="fas fa-plus-circle"></i> Nouvel Événement</h3>
                <form id="eventForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventTitle">Titre de l'événement *</label>
                            <input type="text" id="eventTitle" required
                                   placeholder="Ex: Workshop branding">
                        </div>
                        <div class="form-group">
                            <label for="eventType">Type d'événement *</label>
                            <select id="eventType" required>
                                <option value="">Sélectionner</option>
                                <option value="meeting">Meeting en ligne</option>
                                <option value="workshop">Workshop</option>
                                <option value="exposition">Exposition</option>
                                <option value="conference">Conférence</option>
                                <option value="networking">Networking</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventDate">Date *</label>
                            <input type="date" id="eventDate" required>
                        </div>
                        <div class="form-group">
                            <label for="eventTime">Heure *</label>
                            <input type="time" id="eventTime" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventLocation">Lieu / Plateforme *</label>
                            <input type="text" id="eventLocation" required
                                   placeholder="Ex: Zoom, Paris, En ligne...">
                        </div>
                        <div class="form-group">
                            <label for="eventMaxParticipants">Participants max</label>
                            <input type="number" id="eventMaxParticipants" min="1"
                                   placeholder="Illimité si vide">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="eventDescription">Description *</label>
                        <textarea id="eventDescription" rows="4" required
                                  placeholder="Description détaillée de l'événement..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelEventBtn">Annuler</button>
                        <button type="submit" class="btn btn-primary">Publier l'événement</button>
                    </div>
                </form>
            </div>

            <!-- Liste des événements -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Titre</th>
                            <th>Type</th>
                            <th>Date</th>
                            <th>Lieu</th>
                            <th>Participants</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="eventsTable">
                        <!-- Chargé dynamiquement -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation de suppression -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Confirmation</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer cet élément ? Cette action est irréversible.</p>
                <div class="form-actions">
                    <button class="btn btn-secondary" id="cancelDeleteBtn">Annuler</button>
                    <button class="btn btn-danger" id="confirmDeleteBtn">Supprimer</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuration Supabase (UNE SEULE DÉCLARATION)
        const supabaseUrl = 'https://kfptsbpriihydidnfzhj.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtmcHRzYnByaWloeWRpZG5memhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNjgxODIsImV4cCI6MjA4MTY0NDE4Mn0.R4AS9kj-o3Zw0OeOTAojMeZfjPtkOZiW0jM367Fmrkk';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // Variables globales
        let currentPage = 1;
        let pageSize = 10;
        let totalCreators = 0;
        let deleteId = null;
        let deleteType = null; // 'creator' ou 'event'

        document.addEventListener('DOMContentLoaded', function() {
            // Gestion des onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab + 'Tab').classList.add('active');
                    
                    if (this.dataset.tab === 'events') {
                        loadEvents();
                    } else {
                        loadCreators();
                    }
                });
            });

            // Initialiser les créateurs
            loadCreators();
            setupSearch();
            setupPagination();

            // Gestion des événements
            setupEventManagement();
            setupDeleteModal();
        });

        async function loadCreators() {
            try {
                const { data, error } = await supabase
                    .from('creators')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                totalCreators = data.length;
                updateStats(data);
                displayCreators(data);
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors du chargement des créateurs');
            }
        }

        function updateStats(creators) {
            document.getElementById('totalCreators').textContent = creators.length;
            
            const activeCount = creators.filter(c => {
                const lastActive = new Date(c.last_active || c.created_at);
                const now = new Date();
                const daysDiff = (now - lastActive) / (1000 * 60 * 60 * 24);
                return daysDiff <= 30;
            }).length;
            
            document.getElementById('activeCreators').textContent = activeCount;
            
            const completeCount = creators.filter(c => c.portfolio_complete).length;
            document.getElementById('completePortfolios').textContent = completeCount;
        }

        function displayCreators(creators) {
            const table = document.getElementById('creatorsTable');
            if (!table) return;
            
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageCreators = creators.slice(start, end);
            
            table.innerHTML = pageCreators.map(creator => `
                <tr>
                    <td>
                        <strong>${creator.name || 'Non spécifié'}</strong>
                        ${creator.brand_name ? `<br><small>${creator.brand_name}</small>` : ''}
                    </td>
                    <td>${creator.email || 'Non spécifié'}</td>
                    <td>${creator.domain || 'Non spécifié'}</td>
                    <td>
                        <span class="status-badge ${creator.portfolio_complete ? 'status-active' : 'status-inactive'}">
                            ${creator.portfolio_complete ? 'Complet' : 'Incomplet'}
                        </span>
                    </td>
                    <td>${new Date(creator.created_at).toLocaleDateString('fr-FR')}</td>
                    <td>
                        <span class="status-badge ${creator.status === 'active' ? 'status-active' : 'status-inactive'}">
                            ${creator.status === 'active' ? 'Actif' : 'Inactif'}
                        </span>
                    </td>
                    <td>
                        <div class="actions">
                            <button class="btn-action btn-view" onclick="viewCreator('${creator.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-action btn-delete" onclick="confirmDelete('creator', '${creator.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            updatePaginationInfo();
        }

        function setupSearch() {
            const searchInput = document.getElementById('searchCreator');
            const filterSelect = document.getElementById('filterDomain');
            
            let searchTimeout;
            
            const performSearch = async () => {
                const searchTerm = searchInput.value.toLowerCase();
                const filterValue = filterSelect.value;
                
                try {
                    let query = supabase
                        .from('creators')
                        .select('*');
                    
                    if (searchTerm) {
                        query = query.or(`name.ilike.%${searchTerm}%,brand_name.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);
                    }
                    
                    if (filterValue) {
                        query = query.eq('domain', filterValue);
                    }
                    
                    const { data, error } = await query.order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    totalCreators = data.length;
                    currentPage = 1;
                    displayCreators(data);
                    
                } catch (error) {
                    console.error('Erreur:', error);
                }
            };
            
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(performSearch, 300);
            });
            
            filterSelect.addEventListener('change', performSearch);
        }

        function setupPagination() {
            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadCreators();
                }
            });
            
            document.getElementById('nextPage').addEventListener('click', () => {
                if (currentPage * pageSize < totalCreators) {
                    currentPage++;
                    loadCreators();
                }
            });
        }

        function updatePaginationInfo() {
            const info = document.getElementById('paginationInfo');
            const totalPages = Math.ceil(totalCreators / pageSize);
            info.textContent = `Page ${currentPage} sur ${totalPages} - ${totalCreators} créateurs`;
        }

        function viewCreator(creatorId) {
            // Ouvrir modal avec détails du créateur
            console.log('Voir créateur:', creatorId);
            // Implémenter la vue détaillée
        }

        function confirmDelete(type, id) {
            deleteType = type;
            deleteId = id;
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function setupDeleteModal() {
            const modal = document.getElementById('deleteModal');
            const closeBtn = modal.querySelector('.close-modal');
            const cancelBtn = document.getElementById('cancelDeleteBtn');
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            
            closeBtn.addEventListener('click', () => modal.style.display = 'none');
            cancelBtn.addEventListener('click', () => modal.style.display = 'none');
            
            confirmBtn.addEventListener('click', async () => {
                try {
                    if (deleteType === 'creator') {
                        const { error } = await supabase
                            .from('creators')
                            .delete()
                            .eq('id', deleteId);
                        
                        if (error) throw error;
                        
                        alert('Créateur supprimé avec succès');
                        loadCreators();
                        
                    } else if (deleteType === 'event') {
                        const { error } = await supabase
                            .from('events')
                            .delete()
                            .eq('id', deleteId);
                        
                        if (error) throw error;
                        
                        alert('Événement supprimé avec succès');
                        loadEvents();
                    }
                    
                    modal.style.display = 'none';
                    
                } catch (error) {
                    console.error('Erreur:', error);
                    alert('Erreur lors de la suppression');
                }
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        function setupEventManagement() {
            const addEventBtn = document.getElementById('addEventBtn');
            const cancelEventBtn = document.getElementById('cancelEventBtn');
            const eventForm = document.getElementById('eventForm');
            const formContainer = document.getElementById('eventFormContainer');
            
            addEventBtn.addEventListener('click', () => {
                formContainer.style.display = 'block';
                addEventBtn.style.display = 'none';
                eventForm.reset();
                document.getElementById('eventDate').valueAsDate = new Date();
            });
            
            cancelEventBtn.addEventListener('click', () => {
                formContainer.style.display = 'none';
                addEventBtn.style.display = 'flex';
            });
            
            eventForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const eventData = {
                    title: document.getElementById('eventTitle').value.trim(),
                    type: document.getElementById('eventType').value,
                    date: document.getElementById('eventDate').value,
                    time: document.getElementById('eventTime').value,
                    location: document.getElementById('eventLocation').value.trim(),
                    max_participants: document.getElementById('eventMaxParticipants').value || null,
                    description: document.getElementById('eventDescription').value.trim(),
                    status: 'upcoming',
                    created_at: new Date().toISOString()
                };
                
                try {
                    const { error } = await supabase
                        .from('events')
                        .insert([eventData]);
                    
                    if (error) throw error;
                    
                    alert('Événement publié avec succès !');
                    formContainer.style.display = 'none';
                    addEventBtn.style.display = 'flex';
                    eventForm.reset();
                    loadEvents();
                    
                } catch (error) {
                    console.error('Erreur:', error);
                    alert('Erreur lors de la publication de l\'événement');
                }
            });
        }

        async function loadEvents() {
            try {
                const { data, error } = await supabase
                    .from('events')
                    .select('*')
                    .order('date', { ascending: true });
                
                if (error) throw error;
                
                displayEvents(data);
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors du chargement des événements');
            }
        }

        function displayEvents(events) {
            const table = document.getElementById('eventsTable');
            if (!table) return;
            
            if (events.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            <i class="fas fa-calendar-times" style="font-size: 2rem; opacity: 0.3; margin-bottom: 10px; display: block;"></i>
                            <p>Aucun événement programmé</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            table.innerHTML = events.map(event => {
                const eventDate = new Date(event.date);
                const now = new Date();
                const isPast = eventDate < now;
                
                return `
                    <tr>
                        <td><strong>${event.title}</strong></td>
                        <td>
                            <span class="status-badge ${event.type === 'meeting' ? 'status-active' : 'status-inactive'}">
                                ${getEventTypeLabel(event.type)}
                            </span>
                        </td>
                        <td>
                            ${eventDate.toLocaleDateString('fr-FR')}<br>
                            <small>${event.time}</small>
                        </td>
                        <td>${event.location}</td>
                        <td>${event.max_participants || 'Illimité'}</td>
                        <td>
                            <span class="status-badge ${isPast ? 'status-inactive' : 'status-active'}">
                                ${isPast ? 'Terminé' : 'À venir'}
                            </span>
                        </td>
                        <td>
                            <div class="actions">
                                <button class="btn-action btn-edit" onclick="editEvent('${event.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-action btn-delete" onclick="confirmDelete('event', '${event.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getEventTypeLabel(type) {
            const labels = {
                'meeting': 'Meeting',
                'workshop': 'Workshop',
                'exposition': 'Exposition',
                'conference': 'Conférence',
                'networking': 'Networking'
            };
            return labels[type] || type;
        }

        function editEvent(eventId) {
            // Implémenter l'édition d'événement
            console.log('Éditer événement:', eventId);
        }
    </script>
</body>
</html>
